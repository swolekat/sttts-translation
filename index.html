<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <style>
    html, body {
      background: #fff;
      color: #000;
      padding: 20px;
      font-size: 32px;
    }

    * {
      font-size: 32px;
    }

    body > * {
      margin-bottom: 20px;
    }

  </style>
</head>
<body>
<div>
  Voice activation test LT language
</div>
<input type="text" placeholder="language" id="languageInput"/>
<select id="voiceInput"></select>
<div id="message">

</div>
<div id="message2">

</div>
<script>
  let ALL_VOICES = [];
  let selectedVoice;

  const recognition = new webkitSpeechRecognition();

  const setUpHandlers = () => {
    const voiceElement = document.getElementById('voiceInput');
    voiceElement.onchange = (event) => selectedVoice = ALL_VOICES.find(v => v.voiceURI === event.target.value);
    const languageElement = document.getElementById('languageInput');
    languageElement.onchange = (event) => {
      recognition.lang = event.target.value;
    };
  };

  setUpHandlers();

  const getVoices = () => {
    const voices = window.speechSynthesis.getVoices();
    if(!voices || voices.length == 0){
      return;
    }
    console.log(voices);
    ALL_VOICES = voices;
    const voiceElement = document.getElementById('voiceInput');
    voices.forEach(voice => {
      const option = document.createElement("option");
      option.value = voice.voiceURI;
      option.innerText = voice.voiceURI;
      voiceElement.appendChild(option);
    })
  }

  window.speechSynthesis.onvoiceschanged = getVoices;

  getVoices();


  const ask = async (message) => {
    const element = document.getElementById('message');
    const element2 = document.getElementById('message2');
    element.innerHTML = message;
    const response = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=en&dt=t&q=${encodeURIComponent(message)}`);
    const json = await response.json();
    element2.innerHTML = json[0][0][0];
    console.log(json);
    console.log(json[0][0][0]);
    let utterance = new SpeechSynthesisUtterance(json[0][0][0]);
    utterance.pitch = 1;
    utterance.rate = 1;
    utterance.voice = selectedVoice || ALL_VOICES[0];
    speechSynthesis.speak(utterance);
  };


  recognition.continuous = false;
  recognition.lang = 'lt-LT';
  // recognition.lang = 'en-US';
  // recognition.lang = 'es';
  recognition.interimResults = false;
  let canSendMessage = true;

  recognition.onresult = function (event) {
    if (!event.results) {
      return;
    }
    let message = '';
    for (let x = 0; x < event.results.length; x++) {
      const result = event.results[x];
      if (!result.isFinal) {
        return;
      }
      message += result[0].transcript;
    }
    console.log(message);
    if(!canSendMessage){
      return;
    }
    ask(message);
  }

  recognition.onend = function () {
    recognition.start();
  };

  recognition.start();
</script>
</body>
</html>